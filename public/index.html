<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rooms - Messaging</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="logo">Rooms</h1>
      <div class="header-buttons">
        <button class="btn-settings" id="showSettings">⚙️ Settings</button>
        <button class="btn-create" id="showCreateForm">New Room</button>
      </div>
    </header>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal" style="display: none;">
      <div class="modal-content">
        <button class="modal-close" id="closeSettings">&times;</button>
        <h2>Settings</h2>

        <div class="settings-group">
          <label class="settings-label">Theme</label>
          <div class="radio-group">
            <label class="radio-label" id="themeLight">
              <input type="radio" name="theme" value="light"> <span>Light</span>
            </label>
            <label class="radio-label" id="themeDark">
              <input type="radio" name="theme" value="dark"> <span>Dark</span>
            </label>
          </div>
        </div>

        <div class="settings-group">
          <label class="settings-label">Text Size</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="textSize" value="small"> <span>Small</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="textSize" value="medium"> <span>Medium</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="textSize" value="large"> <span>Large</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Join Room Modal -->
    <div class="modal" id="joinModal" style="display: none;">
      <div class="modal-content">
        <button class="modal-close" id="closeJoinModal">&times;</button>
        <h2>Join Room</h2>
        <form id="joinRoomForm">
          <label class="settings-label" for="joinUsername">Username</label>
          <input type="text" id="joinUsername" placeholder="Your username" required maxlength="50" autocomplete="username">
          <div class="settings-group" id="joinPasswordGroup" style="display: none;">
            <label class="settings-label" for="joinPassword">Password (for private rooms)</label>
            <input type="password" id="joinPassword" placeholder="Room password" autocomplete="current-password">
          </div>
          <button type="submit" class="btn-primary">Join</button>
        </form>
      </div>
    </div>

    <!-- Create Room Form (hidden by default) -->
    <div class="modal" id="createModal" style="display: none;">
      <div class="modal-content">
        <button class="modal-close" id="closeModal">&times;</button>
        <h2>Create Room</h2>
        <form id="createRoomForm">
          <input 
            type="text" 
            id="roomName" 
            placeholder="Room name" 
            required 
            maxlength="50"
          >
          
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="roomType" value="public" checked>
              <span>Public</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="roomType" value="private">
              <span>Private</span>
            </label>
          </div>

          <input 
            type="password" 
            id="roomPassword" 
            placeholder="Password (for private rooms)" 
            disabled
          >

          <button type="submit" class="btn-primary">Create</button>
        </form>
      </div>
    </div>

    <!-- Rooms List -->
    <main class="main">
      <div class="rooms-header">
        <h2>Available Rooms</h2>
        <span class="room-count" id="roomCount">0 rooms</span>
      </div>
      
      <div class="rooms-list" id="roomsList">
        <div class="empty-state">
          <p>No rooms yet. Create one to get started.</p>
        </div>
      </div>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    console.log('Script loaded');
    const socket = io();

    // ========== SETTINGS LOGIC ==========
    function loadSettings() {
      return {
        theme: localStorage.getItem('msg_theme') || 'light',
        textSize: localStorage.getItem('msg_textSize') || 'medium'
      };
    }

    function saveSettings(settings) {
      localStorage.setItem('msg_theme', settings.theme);
      localStorage.setItem('msg_textSize', settings.textSize);
    }

    function applySettings(settings) {
      // Apply theme
      document.documentElement.setAttribute('data-theme', settings.theme);

      // Apply text size
      document.documentElement.setAttribute('data-text-size', settings.textSize);

      // Sync radio buttons
      const themeRadio = document.querySelector(`input[name="theme"][value="${settings.theme}"]`);
      if (themeRadio) themeRadio.checked = true;

      const textSizeRadio = document.querySelector(`input[name="textSize"][value="${settings.textSize}"]`);
      if (textSizeRadio) textSizeRadio.checked = true;
    }

    // Load and apply on page start
    let currentSettings = loadSettings();
    applySettings(currentSettings);

    // Settings modal open/close
    document.getElementById('showSettings').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'flex';
    });

    document.getElementById('closeSettings').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'none';
    });

    document.getElementById('settingsModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('settingsModal')) {
        document.getElementById('settingsModal').style.display = 'none';
      }
    });

    // Listen for settings changes live
    document.querySelectorAll('input[name="theme"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        currentSettings.theme = e.target.value;
        saveSettings(currentSettings);
        applySettings(currentSettings);
      });
    });

    document.querySelectorAll('input[name="textSize"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        currentSettings.textSize = e.target.value;
        saveSettings(currentSettings);
        applySettings(currentSettings);
      });
    });
    // ========== END SETTINGS ==========

    // Check socket connection
    socket.on('connect', () => {
      console.log('Connected to server');
    });

    socket.on('connect_error', (error) => {
      console.error('Connection error:', error);
      alert('Cannot connect to server. Make sure the server is running with "npm start"');
    });

    // DOM elements
    const showCreateBtn = document.getElementById('showCreateForm');
    const closeModalBtn = document.getElementById('closeModal');
    const createModal = document.getElementById('createModal');
    const createForm = document.getElementById('createRoomForm');
    const roomsList = document.getElementById('roomsList');
    const roomCount = document.getElementById('roomCount');
    const roomNameInput = document.getElementById('roomName');
    const roomPasswordInput = document.getElementById('roomPassword');
    const radioButtons = document.querySelectorAll('input[name="roomType"]');

    const joinModal = document.getElementById('joinModal');
    const closeJoinModalBtn = document.getElementById('closeJoinModal');
    const joinRoomForm = document.getElementById('joinRoomForm');
    const joinModalUsernameInput = document.getElementById('joinUsername');
    const joinModalPasswordInput = document.getElementById('joinPassword');
    const joinModalPasswordGroup = document.getElementById('joinPasswordGroup');
    let joinModalRoomId = null;
    let joinModalIsPrivate = false;

    console.log('Button element:', showCreateBtn);

    // Show/hide create modal
    showCreateBtn.addEventListener('click', () => {
      console.log('New Room button clicked');
      createModal.style.display = 'flex';
      console.log('Modal display set to flex');
      roomNameInput.focus();
    });

    closeModalBtn.addEventListener('click', () => {
      console.log('Close button clicked');
      createModal.style.display = 'none';
      createForm.reset();
      roomPasswordInput.disabled = true;
    });

    // Enable/disable password field based on room type
    radioButtons.forEach(radio => {
      radio.addEventListener('change', (e) => {
        console.log('Room type changed to:', e.target.value);
        roomPasswordInput.disabled = e.target.value === 'public';
        if (e.target.value === 'public') {
          roomPasswordInput.value = '';
        }
      });
    });

    // Store password for redirect after creating private room (callback doesn't receive it)
    let pendingCreatePassword = null;

    // Create room
    createForm.addEventListener('submit', (e) => {
      e.preventDefault();
      console.log('Form submitted');
      const name = roomNameInput.value.trim();
      const isPrivate = document.querySelector('input[name="roomType"]:checked').value === 'private';
      const password = isPrivate ? roomPasswordInput.value : null;
      pendingCreatePassword = password;

      console.log('Creating room:', { name, isPrivate, hasPassword: !!password });

      if (isPrivate && !password) {
        alert('Please enter a password for private rooms');
        return;
      }

      socket.emit('create-room', { name, isPrivate, password });
    });

    // Handle room created
    socket.on('room-created', (data) => {
      console.log('Room created successfully:', data);
      createModal.style.display = 'none';
      createForm.reset();
      roomPasswordInput.disabled = true;
      const isPrivate = data.room && data.room.isPrivate;
      const password = isPrivate ? pendingCreatePassword : null;
      pendingCreatePassword = null;

      // Show join modal for username (and pre-fill password for private)
      joinModalRoomId = data.roomId;
      joinModalIsPrivate = isPrivate;
      joinModalPasswordInput.value = password || '';
      joinModalPasswordGroup.style.display = isPrivate ? 'block' : 'none';
      joinModalUsernameInput.value = '';
      joinModalUsernameInput.focus();
      joinModal.style.display = 'flex';
    });

    // Get rooms list on load
    socket.emit('get-rooms');

    // Display rooms
    socket.on('rooms-list', (rooms) => {
      if (rooms.length === 0) {
        roomsList.innerHTML = '<div class="empty-state"><p>No rooms yet. Create one to get started.</p></div>';
        roomCount.textContent = '0 rooms';
        return;
      }

      roomCount.textContent = `${rooms.length} room${rooms.length !== 1 ? 's' : ''}`;
      
      roomsList.innerHTML = rooms.map(room => `
        <div class="room-card" onclick="joinRoom('${room.id}', ${room.isPrivate})">
          <div class="room-info">
            <h3 class="room-name">${escapeHtml(room.name)}</h3>
            <span class="room-users">${room.userCount} ${room.userCount === 1 ? 'user' : 'users'}</span>
          </div>
          <div class="room-meta">
            ${room.isPrivate ? '<span class="room-badge">Private</span>' : '<span class="room-badge public">Public</span>'}
          </div>
        </div>
      `).join('');
    });

    // Update rooms list
    socket.on('rooms-updated', (rooms) => {
      socket.emit('get-rooms');
    });

    // Join room: show modal with labeled fields
    function joinRoom(roomId, isPrivate) {
      joinModalRoomId = roomId;
      joinModalIsPrivate = isPrivate;
      joinModalPasswordGroup.style.display = isPrivate ? 'block' : 'none';
      joinModalUsernameInput.value = '';
      joinModalPasswordInput.value = '';
      joinModalUsernameInput.focus();
      joinModal.style.display = 'flex';
    }

    closeJoinModalBtn.addEventListener('click', () => {
      joinModal.style.display = 'none';
    });
    joinModal.addEventListener('click', (e) => {
      if (e.target === joinModal) joinModal.style.display = 'none';
    });

    joinRoomForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const username = joinModalUsernameInput.value.trim();
      if (!username) return;
      if (joinModalIsPrivate && !joinModalPasswordInput.value) {
        alert('Please enter the room password');
        return;
      }
      const password = joinModalIsPrivate ? joinModalPasswordInput.value : '';
      joinModal.style.display = 'none';
      window.location.href = `/room.html?id=${joinModalRoomId}&username=${encodeURIComponent(username)}${password ? '&password=' + encodeURIComponent(password) : ''}`;
    });

    // Utility function
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Close modal on outside click
    createModal.addEventListener('click', (e) => {
      if (e.target === createModal) {
        createModal.style.display = 'none';
        createForm.reset();
        roomPasswordInput.disabled = true;
      }
    });
  </script>
</body>
</html>